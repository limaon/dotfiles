#!/bin/bash

# Display configuration script with xrandr and autorandr
set -euo pipefail

# Cleanup on exit
cleanup() {
    echo "Cleaning up..."
}
trap cleanup EXIT INT TERM

# Check dependencies
check_dependencies() {
    local deps="xrandr dmenu notify-send awk grep sed"
    for dep in $deps; do
        if ! command -v "$dep" &>/dev/null; then
            echo "Error: Missing required dependency: $dep" >&2
            exit 1
        fi
    done
}

# Validate display exists
validate_display() {
    local display="$1"
    local available="$2"
    if ! echo "$available" | grep -Fxq "$display"; then
        echo "Error: Display '$display' not found" >&2
        exit 1
    fi
}

# Safe xrandr wrapper
safe_xrandr() {
    local desc="$1"
    shift
    if ! xrandr "$@" 2>&1; then
        echo "Error: Failed to $desc" >&2
        exit 1
    fi
}

# Get connected screens
screens=$(xrandr -q | grep " connected" | awk '{print $1}')
screen_count=$(echo "$screens" | wc -l)

# Show menu
chosen=$(printf '%s\nmulti-monitor\nload autorandr profile' "$screens" | dmenu -p "Select display arrangement:")

if [ -z "$chosen" ]; then
    echo "No selection made" >&2
    exit 0
fi

# Check if user selected a display
if echo "$screens" | grep -Fxq "$chosen"; then
    # Single display mode
    safe_xrandr "configure single display" --output "$chosen" --auto
    echo "Configured: $chosen"
elif [ "$chosen" = "multi-monitor" ]; then
    # Multi-monitor mode
    if [ "$screen_count" -lt 2 ]; then
        echo "Error: Need at least 2 displays for multi-monitor" >&2
        exit 1
    fi
    primary=$(echo "$screens" | dmenu -p "Select primary display:")
    validate_display "$primary" "$screens"
    secondary=$(echo "$screens" | grep -Fxv "$primary")
    direction=$(printf "left\nright" | dmenu -p "What side of $primary should $secondary be on?")
    safe_xrandr "configure two-screen setup" --output "$primary" --auto --primary --output "$secondary" --"$direction"-of "$primary" --auto
    echo "Configured: $primary + $secondary ($direction)"
elif [ "$chosen" = "load autorandr profile" ]; then
    # Load autorandr profile
    profiles=$(autorandr --list 2>/dev/null || echo "")
    if [ -z "$profiles" ]; then
        echo "Error: No autorandr profiles found" >&2
        exit 1
    fi
    profile_name=$(echo "$profiles" | dmenu -p "Select profile to load:")
    if [ -z "$profile_name" ]; then
        echo "Profile loading cancelled" >&2
        exit 0
    fi
    if ! echo "$profiles" | grep -Fxq "$profile_name"; then
        echo "Error: Invalid profile name" >&2
        exit 1
    fi
    if autorandr --load "$profile_name"; then
        echo "Profile '$profile_name' loaded"
    else
        echo "Error: Failed to load profile" >&2
        exit 1
    fi
fi
