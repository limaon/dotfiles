#!/usr/bin/env bash
# Memory Usage Block for i3blocks
set -euo pipefail

# Color helper function
get_color() {
    local value=$1
    local type=$2

    case "$type" in
        used)
            if (( value < 50 )); then
                echo "#00ff00"
            elif (( value < 80 )); then
                echo "#ffcc00"
            else
                echo "#ff0000"
            fi
            ;;
        available)  # Higher is better
            if (( value > 50 )); then
                echo "#00ff00"
            elif (( value > 20 )); then
                echo "#ffcc00"
            else
                echo "#ff0000"
            fi
            ;;
        cache)  # Lower is better
            if (( value < 30 )); then
                echo "#00ff00"
            elif (( value < 50 )); then
                echo "#ffcc00"
            else
                echo "#ff0000"
            fi
            ;;
        swap_gb)  # Lower is better
            if (( value == 0 )); then
                echo "#00ff00"
            elif (( value < 4 )); then
                echo "#ffcc00"
            else
                echo "#ff0000"
            fi
            ;;
        top_process)  # Lower is better
            if (( value < 5 )); then
                echo "#00ff00"
            elif (( value < 10 )); then
                echo "#ffcc00"
            else
                echo "#ff0000"
            fi
            ;;
        *)
            echo "#ffffff"
            ;;
    esac
}

MEM_INFO=$(free | grep Mem)
TOTAL=$(echo "$MEM_INFO" | awk '{print $2}')
USED=$(echo "$MEM_INFO" | awk '{print $3}')
PERCENT=$(( USED * 100 / TOTAL ))

# Free percentage for threshold
FREE_PERCENT=$(( 100 - PERCENT ))

# Calculate used memory in GB
USED_GB=$(awk "BEGIN {printf \"%.1f\", $USED / 1024 / 1024}")
TOTAL_GB=$(awk "BEGIN {printf \"%.1f\", $TOTAL / 1024 / 1024}")
FREE_GB=$(awk "BEGIN {printf \"%.1f\", ($TOTAL - $USED) / 1024 / 1024}")

# Format output (matching i3status style)
if (( FREE_PERCENT < 10 )); then
    # Degraded state - show free memory
    FULL_TEXT="MEM: ${FREE_GB}GB"
    SHORT_TEXT="${FREE_GB}GB"
    COLOR="#ff0000"
else
    # Normal - show used memory
    FULL_TEXT="MEM > ${USED_GB}GB"
    SHORT_TEXT="${USED_GB}GB"
    COLOR="#ffffff"
fi

echo "$FULL_TEXT"
echo "$SHORT_TEXT"
echo "$COLOR"

# Click handlers
case "${BLOCK_BUTTON:-}" in
    1)
        # Left click - show top 5 memory processes
        PROCESSES=$(ps aux --sort=-%mem | head -n 6 | awk 'NR>1 {
            print $11, $4
        }' | while read -r proc mem; do
            printf "<span foreground=\"#ffffff\">%s</span>: <b>%s%%</b>\n" "$(basename "$proc")" "$mem"
        done)
        notify-send "Top 5 Memory Processes" "$PROCESSES" -i "org.gnome.SystemMonitor" -a "i3blocks" -r 9901 -t 5000 &
        ;;
    3)
        # Right click - show detailed memory info
        TOTAL_GB=$(( TOTAL / 1024 / 1024 ))
        USED_GB=$(( USED / 1024 / 1024 ))
        FREE_GB=$(( (TOTAL - USED) / 1024 / 1024 ))

        # Get additional memory metrics
        SHARED=$(echo "$MEM_INFO" | awk '{print $5}')
        CACHE=$(echo "$MEM_INFO" | awk '{print $6}')
        AVAILABLE=$(echo "$MEM_INFO" | awk '{print $7}')

        SHARED_GB=$(( SHARED / 1024 / 1024 ))
        CACHE_GB=$(( CACHE / 1024 / 1024 ))
        AVAILABLE_GB=$(( AVAILABLE / 1024 / 1024 ))
        AVAILABLE_PERCENT=$(( AVAILABLE * 100 / TOTAL ))
        CACHE_PERCENT=$(( CACHE * 100 / TOTAL ))

        # Get colors based on usage
        USED_COLOR=$(get_color "$PERCENT" "used")
        AVAILABLE_COLOR=$(get_color "$AVAILABLE_PERCENT" "available")
        CACHE_COLOR=$(get_color "$CACHE_PERCENT" "cache")

        # Swap info
        SWAP_INFO=$(free | grep Swap)
        if [[ -n "$SWAP_INFO" ]]; then
            SWAP_TOTAL=$(echo "$SWAP_INFO" | awk '{print $2}')
            SWAP_USED=$(echo "$SWAP_INFO" | awk '{print $3}')
            if (( SWAP_TOTAL > 0 )); then
                SWAP_USED_GB=$(( SWAP_USED / 1024 / 1024 ))
                SWAP_PERCENT=$(( SWAP_USED * 100 / SWAP_TOTAL ))
                SWAP_COLOR=$(get_color "$SWAP_USED_GB" "swap_gb")
                SWAP_LINE="\n<b>Swap:</b> <span foreground=\"${SWAP_COLOR}\">${SWAP_USED_GB}GB</span> (${SWAP_PERCENT}%)"
            else
                SWAP_LINE="\n<b>Swap:</b> <span foreground=\"#00ff00\">disabled</span>"
            fi
        else
            SWAP_LINE=""
        fi

        # Top memory consumer
        TOP_PROCESS=$(ps aux --sort=-%mem | head -n 2 | tail -n 1)
        TOP_NAME=$(echo "$TOP_PROCESS" | awk '{print $11}' | xargs basename)
        TOP_PERCENT=$(echo "$TOP_PROCESS" | awk '{print $4}')
        TOP_COLOR=$(get_color "$TOP_PERCENT" "top_process")

        # Build info message
        INFO="<b>Total:</b> <span foreground=\"#00ff00\">${TOTAL_GB}GB</span>\n<b>Used:</b> <span foreground=\"${USED_COLOR}\">${USED_GB}GB</span> (${PERCENT}%)\n<b>Free:</b> <span foreground=\"#00ff00\">${FREE_GB}GB</span> (${FREE_PERCENT}%)"
        INFO="${INFO}\n<b>Available:</b> <span foreground=\"${AVAILABLE_COLOR}\">${AVAILABLE_GB}GB</span> (${AVAILABLE_PERCENT}%)"
        INFO="${INFO}\n<b>Cache:</b> <span foreground=\"${CACHE_COLOR}\">${CACHE_GB}GB</span> (${CACHE_PERCENT}%)"
        INFO="${INFO}\n<b>Shared:</b> <span foreground=\"#9999ff\">${SHARED_GB}GB</span>"
        INFO="${INFO}${SWAP_LINE}"
        INFO="${INFO}\n<b>Top:</b> <span foreground=\"${TOP_COLOR}\">${TOP_NAME}</span> (${TOP_PERCENT}%)"

        notify-send "Memory Info" "$INFO" -i "preferences-system-performance" -a "i3blocks" -r 9901 -t 8000 &
        ;;
esac
