#!/usr/bin/env bash
# Memory Usage Block for i3blocks
set -euo pipefail

MEM_INFO=$(free | grep Mem)
TOTAL=$(echo "$MEM_INFO" | awk '{print $2}')
USED=$(echo "$MEM_INFO" | awk '{print $3}')
PERCENT=$(( USED * 100 / TOTAL ))

# Free percentage for threshold
FREE_PERCENT=$(( 100 - PERCENT ))

# Format output (matching i3status style)
if (( FREE_PERCENT < 10 )); then
    # Degraded state - show free memory
    FULL_TEXT="MEMORY: ${FREE_PERCENT}%"
    SHORT_TEXT="${FREE_PERCENT}%"
    COLOR="#ff0000"
else
    # Normal - show used memory
    FULL_TEXT="MEM > ${PERCENT}%"
    SHORT_TEXT="${PERCENT}%"
    COLOR="#ffffff"
fi

echo "$FULL_TEXT"
echo "$SHORT_TEXT"
echo "$COLOR"

# Click handlers
case "${BLOCK_BUTTON:-}" in
    1)
        # Left click - show top 5 memory processes
        ps aux --sort=-%mem | head -n 6 | awk 'NR>1 {
            printf "<span foreground=\"#00ff00\">%s</span> <b>%s</b> - <span foreground=\"#ffffff\">%.1f%%</span>\n", $1, $11, $4
        }' | while IFS= read -r line; do
            notify-send "Top 5 Memory Processes" "${line}" -i "drive-harddisk" -a "i3blocks" -r 9903 -t 5000 &
        done &
        ;;
    3)
        # Right click - show detailed memory info
        TOTAL_GB=$(( TOTAL / 1024 / 1024 ))
        USED_GB=$(( USED / 1024 / 1024 ))
        FREE_GB=$(( (TOTAL - USED) / 1024 / 1024 ))
        INFO="<b>Total:</b> <span foreground=\"#00ff00\">${TOTAL_GB}GB</span>\n<b>Used:</b> <span foreground=\"#ff9900\">${USED_GB}GB</span> (${PERCENT}%)\n<b>Free:</b> <span foreground=\"#00ff00\">${FREE_GB}GB</span> (${FREE_PERCENT}%)"
        notify-send "Memory Info" "$INFO" -i "memory" -a "i3blocks" -r 9904 -t 5000 &
        ;;
esac
