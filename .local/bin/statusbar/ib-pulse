#!/usr/bin/env bash
# Audio/PulseAudio Block for i3blocks (handles sink output and source input)
set -euo pipefail

command -v pamixer >/dev/null || {
  echo "ERROR: pamixer not installed"
  exit 1
}

readonly BLOCK_INSTANCE="${BLOCK_INSTANCE:-}"
readonly BLOCK_BUTTON="${BLOCK_BUTTON:-}"

instance() {
  if [[ -n "$BLOCK_INSTANCE" ]]; then
    pamixer --"$BLOCK_INSTANCE" "$@"
  else
    pamixer "$@"
  fi
}

mixer() {
  if command -v pavucontrol &>/dev/null; then
    i3-msg -q exec pavucontrol
  elif command -v i3-sensible-terminal &>/dev/null; then
    i3-sensible-terminal -e pulsemixer &
    sleep 0.3
    i3-msg '[title="pulsemixer"] floating enable'
  fi
}

# Determine icons based on instance
if [[ "$BLOCK_INSTANCE" == *source* ]]; then
  readonly block_icon=''
  readonly block_icon_mute=''
else
  readonly block_icon='󰕾'
  readonly block_icon_mute='󰝟'
fi

# Handle mouse actions
case $BLOCK_BUTTON in
  1) mixer ;;                  # left click, run pavucontrol
  3) instance --toggle-mute ;; # right click, mute/unmute
  4) instance --unmute -i 5 ;; # scroll up, increase
  5) instance --unmute -d 5 ;; # scroll down, decrease
esac

# Output status
case $(instance --get-mute) in
  "0" | "false")
    echo "$block_icon $(instance --get-volume | cut -d' ' -f1)%"
    ;;
  "1" | "true")
    echo "$block_icon_mute MUTE"
    echo "$block_icon_mute"
    echo "#aaaaaa"
    ;;
  *)
    echo ERROR
    echo E
    echo "#ff0000"
    ;;
esac
