#!/usr/bin/env bash
# Audio/PulseAudio Block for i3blocks (handles sink output and source input)
set -euo pipefail

# Determine if we're handling sink or source
if [[ "${BLOCK_INSTANCE:-}" == *source* ]]; then
  # Microphone (input)
  DEVICE_TYPE="source"
  readonly ICON_NORMAL=''
  readonly ICON_MUTE=''
else
  # Speakers (output)
  DEVICE_TYPE="sink"
  readonly ICON_NORMAL='󰕾'
  readonly ICON_MUTE='󰝟'
fi

instance() {
  case "$DEVICE_TYPE" in
    source)
      if [[ "${BLOCK_INSTANCE:-}" == "default-source" ]]; then
        pamixer --default-source "$@"
      else
        pamixer --source "${BLOCK_INSTANCE#source }" "$@"
      fi
      ;;
    sink)
      if [[ -n "${BLOCK_INSTANCE:-}" && "${BLOCK_INSTANCE:-}" != "default" ]]; then
        pamixer --sink "$BLOCK_INSTANCE" "$@"
      else
        pamixer "$@"
      fi
      ;;
  esac
}

mixer() {
  if command -v pavucontrol &>/dev/null; then
    i3-msg -q exec pavucontrol
  else
    i3-msg -q exec 'i3-sensible-terminal -e pulsemixer'
  fi
}

# Handle mouse actions
case "${BLOCK_BUTTON:-}" in
  1) mixer ;;                  # left click, run pavucontrol
  3) instance --toggle-mute ;; # right click, mute/unmute
  4) instance --unmute -i 5 ;; # scroll up, increase
  5) instance --unmute -d 5 ;; # scroll down, decrease
esac

# Output status
case $(instance --get-mute) in
  "0" | "false")
    echo "$ICON_NORMAL $(instance --get-volume)%"
    echo "#00ff00"
    ;;
  "1" | "true")
    echo "$ICON_MUTE MUTE"
    echo "#AAAAAA"
    ;;
  *)
    echo "$ICON_NORMAL UNK"
    echo "#FF1A1A"
    ;;
esac
