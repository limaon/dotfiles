#!/usr/bin/env bash
# i3blocks module - battery status
# Shows battery percentage with status icon and color-coded thresholds
# Left click: battery summary | Right click: detailed battery info
set -euo pipefail

command -v notify-send >/dev/null 2>&1 || {
  echo "Error: 'notify-send' not found"
  exit 1
}

readonly BATTERY_PATH="/sys/class/power_supply"

get_color() {
  local -r percent="$1"
  local -r status="$2"

  # Charging/Full = blue/green
  if [[ "$status" == "Charging" ]]; then
    echo "#00BFFF"
    return
  elif [[ "$status" == "Full" ]]; then
    echo "#00FF00"
    return
  fi

  # Discharging thresholds
  if (( percent <= 10 )); then
    echo "#FF0000"
  elif (( percent <= 20 )); then
    echo "#FF4500"
  elif (( percent <= 35 )); then
    echo "#FFAE00"
  fi
}

get_status_label() {
  local -r status="$1"
  case "$status" in
    "Charging")     echo "CHR" ;;
    "Discharging")  echo "BAT" ;;
    "Full")         echo "FULL" ;;
    "Not charging") echo "NC" ;;
    *)              echo "UNK" ;;
  esac
}



get_time_remaining() {
  local -r battery="$1"
  local -r status="$2"

  # Try to get time from energy values
  local energy_now energy_full power_now
  energy_now=$(cat "$battery/energy_now" 2>/dev/null || cat "$battery/charge_now" 2>/dev/null || echo "0")
  energy_full=$(cat "$battery/energy_full" 2>/dev/null || cat "$battery/charge_full" 2>/dev/null || echo "0")
  power_now=$(cat "$battery/power_now" 2>/dev/null || cat "$battery/current_now" 2>/dev/null || echo "0")

  if (( power_now > 0 )); then
    local minutes
    if [[ "$status" == "Charging" ]]; then
      minutes=$(( (energy_full - energy_now) * 60 / power_now ))
    else
      minutes=$(( energy_now * 60 / power_now ))
    fi
    local hours=$(( minutes / 60 ))
    local mins=$(( minutes % 60 ))
    printf "%dh%02dm" "$hours" "$mins"
  else
    echo "N/A"
  fi
}

notify_summary() {
  local -r battery="$1"
  local -r capacity="$2"
  local -r status="$3"
  local -r label=$(get_status_label "$status")
  local -r time=$(get_time_remaining "$battery" "$status")

  local msg="${label}: ${capacity}%"
  if [[ "$time" != "N/A" ]]; then
    if [[ "$status" == "Charging" ]]; then
      msg="${msg} (${time} to full)"
    elif [[ "$status" == "Discharging" ]]; then
      msg="${msg} (${time} remaining)"
    fi
  fi

  notify-send -r 9901 -i "battery" -t 3000 "Battery" "$msg" &
}

notify_details() {
  local -r battery="$1"
  local -r capacity="$2"
  local -r status="$3"

  local energy_full energy_full_design health
  energy_full=$(cat "$battery/energy_full" 2>/dev/null || cat "$battery/charge_full" 2>/dev/null || echo "0")
  energy_full_design=$(cat "$battery/energy_full_design" 2>/dev/null || cat "$battery/charge_full_design" 2>/dev/null || echo "0")

  if (( energy_full_design > 0 )); then
    health=$(( energy_full * 100 / energy_full_design ))
  else
    health="N/A"
  fi

  local cycle_count
  cycle_count=$(cat "$battery/cycle_count" 2>/dev/null || echo "N/A")

  local msg="Status: ${status}
Capacity: ${capacity}%
Health: ${health}%
Cycles: ${cycle_count}"

  notify-send -r 9901 -i "battery" -t 0 "Battery Details" "$msg" &
}

# Find first battery
battery=""
for b in "$BATTERY_PATH"/BAT*; do
  if [[ -d "$b" ]]; then
    battery="$b"
    break
  fi
done

# No battery found
if [[ -z "$battery" ]]; then
  echo "No battery"
  echo "No battery"
  exit 0
fi

# Read battery info
capacity=$(cat "$battery/capacity" 2>/dev/null || echo "0")
status=$(cat "$battery/status" 2>/dev/null || echo "Unknown")

# Handle click events
case ${BLOCK_BUTTON:-} in
  1) notify_summary "$battery" "$capacity" "$status" ;;
  3) notify_details "$battery" "$capacity" "$status" ;;
esac

# Get display values
label=$(get_status_label "$status")
color=$(get_color "$capacity" "$status")

# Output: full_text, short_text, color
echo "${label}: ${capacity}%"
echo "${label}: ${capacity}%"
[[ -n "$color" ]] && echo "$color"
