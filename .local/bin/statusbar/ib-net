#!/usr/bin/env bash
# Unified Network Block for i3blocks - Ethernet, WiFi, and VPN detection
set -euo pipefail

# Colors
readonly COLOR_GREEN="#00ff00"
readonly COLOR_ORANGE="#ff9900"
readonly COLOR_RED="#ff0000"
readonly COLOR_CYAN="#00ffff"

# Icons (Nerd Font)
readonly ICON_ETH=" 󰈀 "
readonly ICON_WIFI=" 󰤨 "
readonly ICON_VPN="󰒂"
readonly ICON_DISCONNECTED=" 󰲛 "

# Notification ID for replacement
readonly NOTIFY_ID=9901

get_color() {
  local value="$1"
  local low="${2:-30}"
  local high="${3:-60}"

  if [[ "$value" -ge "$high" ]]; then
    echo "$COLOR_GREEN"
  elif [[ "$value" -ge "$low" ]]; then
    echo "$COLOR_ORANGE"
  else
    echo "$COLOR_RED"
  fi
}

detect_vpn() {
  local vpn_name
  vpn_name=$(nmcli -g NAME,TYPE connection show --active 2>/dev/null | grep -i ':vpn' | cut -d: -f1 | head -n1)
  echo "$vpn_name"
}

detect_ethernet() {
  local iface
  for iface in /sys/class/net/enp* /sys/class/net/eth*; do
    [[ -e "$iface" ]] || continue
    iface=$(basename "$iface")
    if [[ "$(cat "/sys/class/net/$iface/operstate" 2>/dev/null)" == "up" ]]; then
      if ip addr show "$iface" 2>/dev/null | grep -q 'inet '; then
        echo "$iface"
        return
      fi
    fi
  done
}

detect_wifi() {
  local iface
  for iface in /sys/class/net/wl*; do
    [[ -e "$iface" ]] || continue
    iface=$(basename "$iface")
    if [[ "$(cat "/sys/class/net/$iface/operstate" 2>/dev/null)" == "up" ]]; then
      if ip addr show "$iface" 2>/dev/null | grep -q 'inet '; then
        echo "$iface"
        return
      fi
    fi
  done
}

get_wifi_quality() {
  local iface="$1"
  local signal
  signal=$(iw dev "$iface" link 2>/dev/null | awk '/signal:/ {print $2}')
  if [[ -n "$signal" ]]; then
    # Convert dBm to percentage (roughly: -30 dBm = 100%, -90 dBm = 0%)
    local quality=$(( (signal + 90) * 100 / 60 ))
    [[ "$quality" -gt 100 ]] && quality=100
    [[ "$quality" -lt 0 ]] && quality=0
    echo "$quality"
  else
    echo "0"
  fi
}

get_wifi_essid() {
  local iface="$1"
  iw dev "$iface" link 2>/dev/null | awk '/SSID:/ {print $2}'
}

get_connection_name() {
  local iface="$1"
  nmcli -g GENERAL.CONNECTION device show "$iface" 2>/dev/null | head -n1
}

get_ip_address() {
  local iface="$1"
  ip addr show "$iface" 2>/dev/null | awk '/inet / {print $2}' | cut -d/ -f1 | head -n1
}

get_gateway() {
  ip route 2>/dev/null | awk '/default/ {print $3}' | head -n1
}

get_dns() {
  nmcli dev show 2>/dev/null | awk '/IP4.DNS/ {print $2}' | paste -sd, -
}

get_ethernet_speed() {
  local iface="$1"
  cat "/sys/class/net/$iface/speed" 2>/dev/null || echo "N/A"
}

get_wifi_bitrate() {
  local iface="$1"
  iw dev "$iface" link 2>/dev/null | awk '/tx bitrate:/ {print $3 " " $4}'
}

show_network_processes() {
  local tcp_count udp_count procs body
  tcp_count=$(ss -tn state established 2>/dev/null | tail -n +2 | wc -l)
  udp_count=$(ss -un 2>/dev/null | tail -n +2 | wc -l)
  procs=$(ss -tunp 2>/dev/null | grep -oP 'users:\(\("\K[^"]+' | sort -u | head -5 | paste -sd, -)
  [[ -z "$procs" ]] && procs="nenhum"
  body="Conexões: ${tcp_count} TCP, ${udp_count} UDP
Processos: ${procs}"
  notify-send -i org.gnome.SystemMonitor -r "$NOTIFY_ID" "Network" "$body" &
}

show_network_info() {
  local eth_iface wifi_iface vpn_name iface type conn_name ip gateway dns speed_info
  eth_iface=$(detect_ethernet)
  wifi_iface=$(detect_wifi)
  vpn_name=$(detect_vpn)

  if [[ -n "$eth_iface" ]]; then
    iface="$eth_iface"
    type="Ethernet"
    speed_info="Speed: $(get_ethernet_speed "$iface") Mbps"
  elif [[ -n "$wifi_iface" ]]; then
    iface="$wifi_iface"
    type="WiFi"
    local signal
    signal=$(get_wifi_quality "$iface")
    speed_info="Bitrate: $(get_wifi_bitrate "$iface")\nSignal: ${signal}%"
  else
    notify-send -i preferences-system-network -r "$NOTIFY_ID" "Network Status" "No network connection" &
    return
  fi

  conn_name=$(get_connection_name "$iface")
  ip=$(get_ip_address "$iface")
  gateway=$(get_gateway)
  dns=$(get_dns)

  local vpn_status="Not connected"
  [[ -n "$vpn_name" ]] && vpn_status="$vpn_name (Connected)"

  local body
  body="Interface: $iface ($type)
Connection: $conn_name
VPN: $vpn_status
IP: $ip
Gateway: $gateway
$speed_info
DNS: $dns"

  notify-send -i preferences-system-network -r "$NOTIFY_ID" "Network Status" "$body" &
}

handle_click() {
  case "${BLOCK_BUTTON:-}" in
    1) show_network_processes ;;
    3) show_network_info ;;
  esac
}

main() {
  handle_click

  local eth_iface wifi_iface vpn_name output color

  eth_iface=$(detect_ethernet)
  wifi_iface=$(detect_wifi)
  vpn_name=$(detect_vpn)

  if [[ -n "$eth_iface" ]]; then
    local conn_name ip
    conn_name=$(get_connection_name "$eth_iface")
    ip=$(get_ip_address "$eth_iface")

    if [[ -n "$vpn_name" ]]; then
      output="$ICON_VPN $conn_name $ICON_VPN VPN ($ip)"
      color="$COLOR_CYAN"
    else
      output="$ICON_ETH $conn_name ($ip)"
      color="$COLOR_GREEN"
    fi
  elif [[ -n "$wifi_iface" ]]; then
    local essid signal
    essid=$(get_wifi_essid "$wifi_iface")
    signal=$(get_wifi_quality "$wifi_iface")
    ip=$(get_ip_address "$wifi_iface")

    if [[ -n "$vpn_name" ]]; then
      output="$ICON_WIFI $essid (${signal}%) $ICON_VPN VPN ($ip)"
      color="$COLOR_CYAN"
    else
      output="$ICON_WIFI $essid (${signal}%) ($ip)"
      color=$(get_color "$signal")
    fi
  else
    # No connection - show disconnected icon
    echo "$ICON_DISCONNECTED No network"
    echo "$ICON_DISCONNECTED"
    echo "$COLOR_RED"
    exit 0
  fi

  # i3blocks format: full_text, short_text, color
  echo "$output"
  echo "$output"
  echo "$color"
}

main "$@"
