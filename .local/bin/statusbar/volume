#!/usr/bin/env bash
# Volume (master) Block for i3blocks
set -euo pipefail

instance() {
  pamixer "${DEVICE[@]}" "$@"
}

mixer() {
  if command -v pavucontrol &>/dev/null; then
    i3-msg -q exec pavucontrol
  else
    i3-msg -q exec 'i3-sensible-terminal -e pulsemixer'
  fi
}

if [[ -n "${BLOCK_INSTANCE:-}" ]]; then
  read -r -a DEVICE <<<"--sink $BLOCK_INSTANCE"
else
  DEVICE=()
fi

# Handle mouse actions
case "${BLOCK_BUTTON:-}" in
  1) mixer ;;                  # left click, run pavucontrol
  3) instance --toggle-mute ;; # right click, mute/unmute
  4) instance --unmute -i 5 ;; # scroll up, increase
  5) instance --unmute -d 5 ;; # scroll down, decrease
esac

# Output status
case $(instance --get-mute) in
  "0" | "false")
    VOL=$(instance --get-volume)
    echo "VOL:${VOL}"
    echo "#00ff00"
    ;;
  "1" | "true")
    echo "VOL: Muted"
    echo "#ff0000"
    ;;
  *)
    echo "VOL: UNK"
    echo "#ff0000"
    ;;
esac
